#!/bin/sh
# Usage: config-participant-table
# Input and output filename are currently fixed
#    input: personnel.config institutions.config
#    outputs: participant-table.tex
#
# This generates a table of proposal participants, ordered by
# institution and distinguishing the co-PI and the remaining senior
# personnel.  It is used in the abstract and perhaps elsewhere.
#
# Note that sometimes, the FOA asks for emails of the co-PIs.  That's
# not in this script, but could easily be added.  To minimize space,
# the best thing is to add "(email)" after the co-PI name, within a
# single column of the table.

lead="$1"

configfile="personnel.config"
instconfig="institutions.config"
tablefile="participant-table.tex"

insttmp="/tmp/config-participant-table.$$"

# Must strip out comments from institutions.config and make sure it is sorted
grep -v "^\#" $instconfig | awk -F\| '{print $1 "|" $4}' | sort > $insttmp

###############################################################################
# Participant table
###############################################################################

echo "% Generated by $0 on `date`" > $tablefile

cat <<EOF >> $tablefile
\begin{tabularx}{\textwidth}{llll}
\emph{Institution} & \emph{Principal Investigator}
  & \emph{Email} & \emph{Phone}
EOF

# personnel.config must be resorted into order by institution, then
# role, then name
#
# Note: depends on 'sp' role sorting after all roles that imply a new
# table row

# Pick out lead: awk -F\| "\$3 ~ /$lead/ {print;}"

grep -v "^\#" $configfile | \
  sort -t \| -k 3,4 -k 1,2 | \
  join -t \| -1 3 -2 1 -a1 -o 1.1 1.2 1.3 1.4 1.5 1.6 1.7 2.2 - $insttmp | \
  awk -F\| \
    '$4 ~ /(lpi)|(cpi)/ \
       {printf "\\\\\n\\%s", $3; \
       if ($8 == "u") {print "$^*$"}; \
       printf " & %s %s & \\emph{%s} & %s ", $2, $1, $5, $6;} ' \
     >> $tablefile

echo "\\\\" >> $tablefile

cat <<EOF >> $tablefile
\end{tabularx}
\medskip
\begin{tabularx}{\textwidth}{lX}
\emph{Institution} & \emph{Additional Senior Personnel}
EOF

grep -v "^\#" $configfile | awk -F\| '$4 ~ /sp/ {print;}' | \
  sort -t \| -k 3,4 -k 1,2 | \
  join -t \| -1 3 -2 1 -a1 -o 1.1 1.2 1.3 1.4 1.5 1.6 1.7 2.2 - $insttmp | \
  awk -F\| \
    'BEGIN {previnst="XXX";} \
    $3 != previnst \
       {printf "\\\\\n\\%s & ", $3; \
       previnst=$3; \
       addcomma=0}; \
     $4 ~ /sp/ \
        {if (addcomma==1) {printf ", "}; \
         printf "%s %s", $2, $1; \
          addcomma=1} ' \
     >> $tablefile

echo "\\\\" >> $tablefile

# Check whether or not there are unfunded colaborators
grep -q "[^|]*|u" $insttmp

if [ $? -eq 0 ]; then
  echo "\multicolumn{3}{l}{\emph{$^*$ Unfunded collaborator}} \\\\" >> $tablefile
fi

echo "\end{tabularx}" >> $tablefile

rm -f $insttmp
